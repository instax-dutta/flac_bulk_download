<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Downloads - Player</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; }
      .container { max-width: 960px; margin: 0 auto; }
      .track { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 0; border-bottom: 1px solid #eee; }
      audio { width: 100%; }
      .meta { flex: 1; margin-right: 12px; }
      .name { font-weight: 600; word-break: break-word; }
      form { margin: 0; }
      button { background: #e11d48; color: white; border: 0; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
      button:hover { background: #be123c; }
      .flash { padding: 8px 12px; border-radius: 6px; margin-bottom: 16px; }
      .success { background: #ecfdf5; color: #065f46; }
      .warning { background: #fffbeb; color: #92400e; }
      .error { background: #fef2f2; color: #991b1b; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
      .badge { background:#eef2ff; color:#3730a3; border-radius: 999px; padding: 2px 8px; font-size:12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Downloaded Tracks</h1>
        <div class="badge">{{ tracks|length }} files</div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if not tracks %}
        <p>No audio files found in the downloads folder.</p>
      {% else %}
        {% for name in tracks %}
          <div class="track">
            <div class="meta">
              <div class="name">{{ name }}</div>
              <audio controls preload="none" class="player">
                <source src="{{ url_for('serve_audio', filename=name) }}" type="audio/flac" />
                Your browser does not support the audio element.
              </audio>
            </div>
            <form method="post" action="{{ url_for('delete_track', filename=name) }}">
              <button type="submit">Delete</button>
            </form>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    <script>
      // Ensure only one audio element plays at a time
      (function () {
        const players = Array.from(document.querySelectorAll('audio.player'));
        players.forEach((p) => {
          p.addEventListener('play', () => {
            players.forEach((other) => {
              if (other !== p && !other.paused) {
                other.pause();
              }
            });
          });
        });
      })();

      // Preserve scroll position across delete redirects
      (function () {
        const KEY = 'downloads_scroll_top';

        // Restore on load
        const saved = sessionStorage.getItem(KEY);
        if (saved) {
          const y = parseInt(saved, 10);
          if (!Number.isNaN(y)) {
            window.scrollTo(0, y);
          }
          // One-time restore
          sessionStorage.removeItem(KEY);
        }

        // Before submitting any delete form, save scroll
        document.addEventListener('submit', function (e) {
          const target = e.target;
          if (target && target.tagName === 'FORM' && target.action.includes('/delete/')) {
            sessionStorage.setItem(KEY, String(window.scrollY || document.documentElement.scrollTop));
          }
        }, true);

        // Fallback: also save before unload
        window.addEventListener('beforeunload', function () {
          sessionStorage.setItem(KEY, String(window.scrollY || document.documentElement.scrollTop));
        });
      })();
    </script>
  </body>
  </html>


